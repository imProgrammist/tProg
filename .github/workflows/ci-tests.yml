name: C++ CI - Build and Run Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: windows-latest  # –ò—Å–ø–æ–ª—å–∑—É–µ–º Windows –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Visual Studio
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v4
      
    # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–±–æ—Ä–∫–∏ Visual Studio
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    # –®–∞–≥ 3: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    - name: Project Structure
      run: |
        echo "=== –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ==="
        echo "–§–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ:"
        dir
        echo ""
        echo "Solution —Ñ–∞–π–ª—ã:"
        dir *.sln
        echo ""
        echo "–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–æ–≤:"
        dir /s *.vcxproj
      
    # –®–∞–≥ 4: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ NuGet –ø–∞–∫–µ—Ç–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
    - name: Restore NuGet Packages
      run: |
        echo "=== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï NUGET –ü–ê–ö–ï–¢–û–í ==="
        if exist "packages.config" (
          nuget restore
        ) else (
          echo "–§–∞–π–ª packages.config –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
        )
      
    # –®–∞–≥ 5: –°–±–æ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è
    - name: Build Solution
      run: |
        echo "=== –°–ë–û–†–ö–ê –†–ï–®–ï–ù–ò–Ø ==="
        msbuild TestingSystem.sln /p:Configuration=Release /p:Platform=x64 /p:RestorePackages=false /verbosity:minimal
      
    # –®–∞–≥ 6: –ü–æ–∏—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    - name: Find Test Executable
      run: |
        echo "=== –ü–û–ò–°–ö –ò–°–ü–û–õ–ù–Ø–ï–ú–û–ì–û –§–ê–ô–õ–ê –¢–ï–°–¢–û–í ==="
        echo "–†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ Tests.exe:"
        dir Tests.exe /s
        echo ""
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–æ–∫:"
        dir /s
      
    # –®–∞–≥ 7: –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    - name: Run Unit Tests
      run: |
        echo "=== –ó–ê–ü–£–°–ö –ú–û–î–£–õ–¨–ù–´–• –¢–ï–°–¢–û–í ==="
        
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏ –∫ —Ç–µ—Å—Ç–∞–º
        if exist "Tests\x64\Release\Tests.exe" (
          echo "‚úÖ –ù–∞–π–¥–µ–Ω Tests.exe –≤ Tests\x64\Release\"
          echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          Tests\x64\Release\Tests.exe
        ) else if exist "x64\Release\Tests\Tests.exe" (
          echo "‚úÖ –ù–∞–π–¥–µ–Ω Tests.exe –≤ x64\Release\Tests\"
          echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          x64\Release\Tests\Tests.exe
        ) else if exist "Tests\Tests.exe" (
          echo "‚úÖ –ù–∞–π–¥–µ–Ω Tests.exe –≤ Tests\"
          echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          Tests\Tests.exe
        ) else (
          echo "‚ùå –§–∞–π–ª Tests.exe –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –æ–∂–∏–¥–∞–µ–º—ã–º –ø—É—Ç—è–º!"
          echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ .exe —Ñ–∞–π–ª—ã:"
          dir *.exe /s
          exit 1
        )
      
    # –®–∞–≥ 8: –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    - name: Test Completion
      run: |
        echo ""
        echo "üéâ =============================== üéâ"
        echo "‚úÖ –í–°–ï –¢–ï–°–¢–´ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–´!"
        echo "‚úÖ CI/CD –ù–ê–°–¢–†–û–ï–ù –ö–û–†–†–ï–ö–¢–ù–û!"
        echo "üéâ =============================== üéâ"