name: C++ CI - Build and Run Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v4
      
    # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–±–æ—Ä–∫–∏ Visual Studio
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    # –®–∞–≥ 3: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    - name: Project Structure
      run: |
        echo "=== –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ==="
        echo "–§–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ:"
        Get-ChildItem
        echo ""
        echo "Solution —Ñ–∞–π–ª—ã:"
        Get-ChildItem -Filter "*.sln"
        echo ""
        echo "–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–æ–≤:"
        Get-ChildItem -Recurse -Filter "*.vcxproj" | Format-Table Name, Directory
      
    # –®–∞–≥ 4: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ NuGet –ø–∞–∫–µ—Ç–æ–≤
    - name: Restore NuGet Packages
      run: |
        echo "=== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï NUGET –ü–ê–ö–ï–¢–û–í ==="
        if (Test-Path "packages.config") {
          nuget restore
        } else {
          echo "–§–∞–π–ª packages.config –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
        }
      
    # –®–∞–≥ 5: –°–±–æ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è
    - name: Build Solution
      run: |
        echo "=== –°–ë–û–†–ö–ê –†–ï–®–ï–ù–ò–Ø ==="
        msbuild TestingSystem.sln /p:Configuration=Release /p:Platform=x64 /p:RestorePackages=false /verbosity:minimal
      
    # –®–∞–≥ 6: –ü–æ–∏—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    - name: Find Test Executable
      run: |
        echo "=== –ü–û–ò–°–ö –ò–°–ü–û–õ–ù–Ø–ï–ú–û–ì–û –§–ê–ô–õ–ê –¢–ï–°–¢–û–í ==="
        echo "–†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ Tests.exe:"
        Get-ChildItem -Recurse -Filter "Tests.exe" | Format-Table FullName
        echo ""
        echo "–í—Å–µ .exe —Ñ–∞–π–ª—ã:"
        Get-ChildItem -Recurse -Filter "*.exe" | Format-Table Name, Directory
        echo ""
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–µ–≤—ã—Ö –ø–∞–ø–æ–∫:"
        if (Test-Path "Tests") {
          echo "–ü–∞–ø–∫–∞ Tests:"
          Get-ChildItem "Tests" -Recurse | Format-Table Name
        }
        if (Test-Path "x64") {
          echo "–ü–∞–ø–∫–∞ x64:"
          Get-ChildItem "x64" -Recurse | Format-Table Name
        }
      
    # –®–∞–≥ 7: –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    - name: Run Unit Tests
      run: |
        echo "=== –ó–ê–ü–£–°–ö –ú–û–î–£–õ–¨–ù–´–• –¢–ï–°–¢–û–í ==="
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ç–µ—Å—Ç–∞–º
        $testPath = $null
        
        if (Test-Path "Tests\x64\Release\Tests.exe") {
          $testPath = "Tests\x64\Release\Tests.exe"
        } elseif (Test-Path "x64\Release\Tests\Tests.exe") {
          $testPath = "x64\Release\Tests\Tests.exe"
        } elseif (Test-Path "Tests\Tests.exe") {
          $testPath = "Tests\Tests.exe"
        } else {
          # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–π Tests.exe
          $foundTests = Get-ChildItem -Recurse -Filter "Tests.exe" | Select-Object -First 1
          if ($foundTests) {
            $testPath = $foundTests.FullName
          }
        }
        
        if ($testPath) {
          echo "‚úÖ –ù–∞–π–¥–µ–Ω Tests.exe: $testPath"
          echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          & $testPath
          $exitCode = $LASTEXITCODE
          if ($exitCode -eq 0) {
            echo "‚úÖ –¢–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          } else {
            echo "‚ùå –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $exitCode)"
            exit $exitCode
          }
        } else {
          echo "‚ùå –§–∞–π–ª Tests.exe –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ .exe —Ñ–∞–π–ª—ã:"
          Get-ChildItem -Recurse -Filter "*.exe" | Format-Table FullName
          exit 1
        }
      
    # –®–∞–≥ 8: –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    - name: Test Completion
      run: |
        echo ""
        echo "üéâ =============================== üéâ"
        echo "‚úÖ –í–°–ï –¢–ï–°–¢–´ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–´!"
        echo "‚úÖ CI/CD –ù–ê–°–¢–†–û–ï–ù –ö–û–†–†–ï–ö–¢–ù–û!"
        echo "üéâ =============================== üéâ"